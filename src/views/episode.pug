doctype(html)
html
  head
    meta(charset='UTF-8')
    meta(http-equiv='X-UA-Compatible' content='IE=edge')
    meta(name='viewport' content='width=device-width, initial-scale=1.0')
    link(href='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css' rel='stylesheet' integrity='sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3' crossorigin='anonymous')
    link(rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css')
    link(rel='stylesheet' href='https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.css')
    link(href='/public/css/styles.css' rel='stylesheet')
    link(href='/public/css/jquery.dataTables.min.css' rel='stylesheet')
    link(href='/public/css/styles.css' rel='stylesheet')
    title No Agenda Producer Database - Episode Credits
  body 
    nav.navbar.dark.bg-dark
      .container-fluid
        a.navbar-brand(href='/')
          img.d-inline-block.align-text-top(src='/public/images/na_logo.png' alt='No Agenda Show logo' width='30' height='30')
          |             No Agenda Producer Database
        form.d-flex(role='search' action='/search')
          input.form-control.me-2(type='search' placeholder='producer, episode, date' aria-label='Search')
          button.btn.btn-outline-success(type='submit') Search
    .container
      .row.pt-4
        .container-fluid
          h1 Episodes
      .row.pt-4
        .container-fluid
          div(style="text-align: right") 
              button#export-json(class="btn btn-success me-3" type="button") Export JSON
              button#export-csv(class="btn btn-success" type="button") Export CSV 
          div(class="table-responsive")
            table(data-toggle="true" data-search="true" data-search-align="right")
              thead
                tr
                  th(data-filter-control='select', data-sortable='true') Date
                  th(data-filter-control='select', data-sortable='true') Number
                  th(data-filter-control='select', data-sortable='true') Title 
                  th(data-filter-control='select', data-sortable='true') Producer
                  th(data-filter-control='select', data-sortable='true') Type
                  th(data-filter-control='select', data-sortable='true') Art, Artist
                tbody
                  each credit in episodeCredits
                    -var imgSrc = "/art/" + credit.episode_number + ".png"
                    tr
                      td(class="text-center") #{credit.episode_date}
                      td(class="text-center")
                        a(target="_blank" href="https://noagendashow.net/listen/"+credit.episode_number) #{credit.episode_number}
                      td(class="text-center")
                        a(target="_blank" href="https://noagendashow.net/listen/"+credit.episode_number) #{credit.title}
                      td(class="text-center") 
                        a(href="/producer/"+credit.producer) #{credit.producer}
                      td(class="text-center") #{credit.type}
                      td(class="text-center")
                        a(target="_blank" href="https://noagendashow.net/listen/"+credit.episode_number)
                          img(class="art" src=imgSrc)
                        br
                        a(href="/producer/"+credit.episode_artist) #{credit.episode_artist}

    script(src='https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.2.0/papaparse.min.js')
    script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js' integrity='sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p' crossorigin='anonymous')
    script(src='https://unpkg.com/bootstrap-table@1.21.2/dist/bootstrap-table.min.js')
    script.
      $(document).ready(function() {
          function exportCsv(data) {
            var newData = data.map(function(item) {
              const episode_date = item[0]; 
              const episode_num = item[1].match(/(?<=href=")[^"]+/)[0].split("/")[4]
              const episode_title = item[2].match(/(?<=<a[^>]*>)[^<]+/);
              const producer_alias = item[3].match(/(?<=<a[^>]*>)[^<]+/);
              const credit_type = item[4]
              const artist = item[5].match(/(?<=<a[^>]*>)[^<]+/);
              return {
                "Episode Date": episode_date,
                "Episode Number": episode_num,
                "Episode Title": episode_title,
                "Producer": producer_alias,
                "Type": credit_type,
                "Artist": artist,
              }
            });
            var csv = Papa.unparse(newData);
            var blob = new Blob([csv], {type: "text/csv"});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'NAEpisodeCredits.csv';
            a.click();
          }

          function exportJson(data) {
            var newData = data.map(function(item) {
              const episode_date = item[0]; 
              const episode_num = item[1].match(/(?<=href=")[^"]+/)[0].split("/")[4]
              const episode_title = item[2].match(/(?<=<a[^>]*>)[^<]+/)[0].replace(/[\[\]]/, '');
              const producer_alias = item[3].match(/(?<=<a[^>]*>)[^<]+/)[0].replace(/[\[\]]/, '');
              const credit_type = item[4]
              const artist = item[5].match(/(?<=<a[^>]*>)[^<]+/)[0].replace(/[\[\]]/, '');
              return {
                "Episode Date": episode_date,
                "Episode Number": episode_num,
                "Episode Title": episode_title,
                "Producer": producer_alias,
                "Type": credit_type,
                "Artist": artist,
              }
            });
            var json = JSON.stringify(newData);
            var blob = new Blob([json], {type: "application/json"});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'NAEpisodeCredits.json';
            a.click();
          }

    
          $('table').bootstrapTable();

          $('#export-json').click(function() {
              var data = $('table').bootstrapTable('getData', {useCurrentPage: true});
              exportJson(data);
          });

          $('#export-csv').click(function() {
              var data = $('table').bootstrapTable('getData', {useCurrentPage: true});
              exportCsv(data);
          });   
      });